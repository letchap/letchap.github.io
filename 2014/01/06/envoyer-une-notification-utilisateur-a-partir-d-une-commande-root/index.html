<!doctype html>
<html class="no-js" lang="en">
  <head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="author" content="letchap">
	<title>Envoyer une notification utilisateur à partir d'une commande root</title>

	<!-- Style -->
	<link rel="stylesheet" href="../../../../theme/css/app.css"/> <!--#TODO changer le path -->

	<!--link rel="stylesheet" href="../../../../theme/css/style.css"/-->
	<link rel="stylesheet" href="../../../../theme/css/pygments.css"/>
    <link rel="stylesheet" href="../../../../theme/css/foundation-icons.css"/>
    <link rel="stylesheet" href="../../../../theme/css/lightbox.css"/>
    <link rel="stylesheet" href="../../../../theme/css/newicons.css"/>
    <!-- Syndication -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="letchap RSS Feed"/>

    <!-- Google analytics -->


    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K7EEZEDYMT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-K7EEZEDYMT');
    </script>




  </head>

  <body>
  <!--'body'content'here'-->
    <!-- Nav Bar -->
    <nav class="top-bar">
      <div class="top-bar-left">
         <ul class="menu">
           <li class="menu-text">
             <a href="../../../..">Accueil</a>
           </li>
           <li class="menu-text">
            <a href="../../../../pages/a-propos.html">A propos</a>
           </li>
         </ul>
      </div>

      <div class="top-bar-right">
        <ul class="menu">
          <li><a href="../../../../archives.html"><i class="fi-list-thumbnails"></i> Archives</a></li>
          <li><a href="/atom.xml" type="application/atom+xml" rel="subscribe-rss"
               title="Subscribe via RSS"><i class="fi-rss"></i></a></li>

          <form action="https://duckduckgo.com" method="get">
            <div class="grid-container">
              <div class="grid-x grid-padding-x" >
                <div class="medium-9 cell">
                 <input type="search" name="q" placeholder="Search">
                 <input type="hidden" name="sites" value="letchap.github.io" />

                </div>
              </div>
            </div>
          </form>
        </ul>
      </div>
    </nav>
    <!-- Nav Bar -->

    <!-- Header -->
    <header class="callout large" id="myheader">
      <div class="text-left">
                  <h2><a href="../../../..">letchap</a></h2>
      </div>
        <h2><small>du Linux, du Python, un peu de Mac</small></h2>
    </header>
    <!-- Header -->



  <!-- Main Page Content and Sidebar -->
  <section role="main">
    <div class="grid-container">
        <div class="grid-x grid-margin-x grid-margin-y">

        <!-- Main Blog Content -->
        <div class="medium-9 cell">
<section>
  <article>
	<h2><a href="../../../../2014/01/06/envoyer-une-notification-utilisateur-a-partir-d-une-commande-root/" rel="bookmark" title="Permalink to Envoyer une notification utilisateur à partir d'une commande root">Envoyer une notification utilisateur à partir d'une commande root</a></h2>
	
	<hr />
	<i class="fi-calendar size-14"></i>&nbsp;Mon 06 January 2014&nbsp;&nbsp;
    <i class="fi-price-tag size-14"></i><a href="../../../../category/shell.html">&nbsp;Shell</a>
	<hr />
	
	<p>Vous allez me dire, à quoi ça sert ? On ne devrait jamais se connecter en root ! C'est dangereux et cela signifie que les droits sont mal gérés. Si je veux envoyer une notification utilisateur, je lance la commande en tant qu'utilisateur, un point c'est tout. Malheureusement, cela ne fonctionne pas avec anacron qui ne s'exécute qu'en root, à moins de créer une instance non root spécialement <a href="../../../../2013/10/25/lancer-anacron-comme-simple-utilisateur/">ce que je détaille ici</a>. Et là patatras, un job lancé par anacron en root n'enverra jamais de message sur une session utilisateur.</p>
<p>Pour la suite de l'article, il faut avoir en tête qu'à chaque utilisateur est associé une session du serveur X qui gère notammenent l'interface graphique. Par défaut, le root n'a pas le droit de se connecter au serveur X d'un utilisateur non-root.</p>
<p>Heureusement, il est possible de forcer un job lancé en root à envoyer un message sur une session du serveur X. Pour cela nous allons modifier la variable d'environnement DISPLAY du root que nous allons fusionner avec celle de l'utilisateur le temps de l'exécution de la commande.</p>
<p>La variable d'environnement DISPLAY contient les éléments suivants :
    <code>machine:numéro_display.numéro_écran</code></p>
<p>Pour un simple utilisateur comme moi, pas de nom de machine, un seul écran, elle va donc s'afficher avec <code>:0.0</code></p>
<p>Maintenant, comment rappatrier l'authentification au serveur X de l'utilisateur et le passer au root : en utilisant la commande <code>xauth</code>. <code>xauth</code> est utilisé pour éditer et fournir les authorisations d'un serveur X. Associé à la commande <code>merge</code>, elle va permettre de récupérer les authorisations de l'utilisateur et les passer au root.</p>
<p>Enfin, pour ne faire cette opération que le temps de l'exécution de la commande, nous allons utiliser la commande <code>env</code> qui permet justement de définir une variable le temps de la commande.</p>
<p>Un dernier point avant d'afficher la solution. Mais où récupère t-on les authorisations de l'utlisateur ?</p>
<p>Pour cela, il faut connaître son gestionnaire d'affichage, ou Display Manager dans la langue de Stallman. Les plus connus sont gdm ou kdm. Bon sur Crunchbang, c'est slim (sur Archlinux aussi d'ailleurs). Pour s'en assurer, il suffit de faire :</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>/etc/X11/default-display-manager
/usr/bin/slim
</code></pre></div>

<p>Les informations qui nous intéressent vont se trouver dans le fichier <code>/etc/slim.conf</code>.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>/etc/slim.conf
<span class="c1"># Xauth file for server</span>
authfile<span class="w">           </span>/var/run/slim.auth
</code></pre></div>

<p>Voilà, les authorisations de l'utilisateur se trouvent dans le fichier <code>/var/run/slim.auth</code>.</p>
<p>Il ne reste plus qu'à compiler tout ça, et la solution est :</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>env<span class="w"> </span><span class="nv">DISPLAY</span><span class="o">=</span>:0<span class="w"> </span>xauth<span class="w"> </span>merge<span class="w"> </span>/var/run/slim.auth<span class="w"> </span><span class="p">&amp;</span><span class="w"> </span>ma_commande
</code></pre></div>
	
  </article>
  <hr />
	<div class="grid-container">
      <div class="grid-x grid-padding-x">
        <div class="cell large-12">
          <div id="cusdis_thread"
            data-host="https://cusdis.com"
            data-app-id="0e5fe46f-ef6e-4be2-abb1-5abe9211600f"
            data-page-id=""
            data-page-url="pages/{slug}.html"
            data-page-title="">
          </div>
        </div>
      </div>
    </div>
    <script async defer src="https://cusdis.com/js/cusdis.es.js"></script>

</section>
        </div>

        <!-- End Main Content -->
    
        <!-- Sidebar -->
    
        <div class="medium-3 cell">
          <div class="callout large secondary">

		  <h4>Catégories</h4>
		  <ul class="vertical menu">
		    <li><a href="../../../../category/archlinux.html">Archlinux</a></li>
		    <li><a href="../../../../category/conky.html">Conky</a></li>
		    <li><a href="../../../../category/crunchbang.html">Crunchbang</a></li>
		    <li><a href="../../../../category/foundation.html">Foundation</a></li>
		    <li><a href="../../../../category/freebox.html">Freebox</a></li>
		    <li><a href="../../../../category/linux.html">Linux</a></li>
		    <li><a href="../../../../category/lubuntu.html">Lubuntu</a></li>
		    <li><a href="../../../../category/mac-os-x.html">Mac OS X</a></li>
		    <li><a href="../../../../category/mageia.html">Mageia</a></li>
		    <li><a href="../../../../category/microbe.html">Microbe</a></li>
		    <li><a href="../../../../category/misc.html">misc</a></li>
		    <li><a href="../../../../category/octopress.html">Octopress</a></li>
		    <li><a href="../../../../category/openshift.html">Openshift</a></li>
		    <li><a href="../../../../category/pelican.html">Pelican</a></li>
		    <li><a href="../../../../category/python.html">Python</a></li>
		    <li><a href="../../../../category/shell.html">Shell</a></li>
		    <li><a href="../../../../category/terminal.html">Terminal</a></li>
		    <li><a href="../../../../category/unowhy-y13.html">Unowhy Y13</a></li>
		    <li><a href="../../../../category/virtualbox.html">VirtualBox</a></li>
		  </ul>

		  <h4>Social</h4>
		  <ul class="vertical menu">
		    <li>
			  <a href="https://mastodon.social/@letchap">
			  <i class="icon-mastodon medium"></i> mastodon
			  </a>
			</li>
		    <li>
			  <a href="https://github.com/letchap">
			  <i class="icon-github medium"></i> github
			  </a>
			</li>
		  </ul>

          </div>
	    </div>
      </div>
      <!-- End Sidebar -->
    </div>
 
  <!-- End Main Content and Sidebar -->

  <!-- Footer -->
   <footer>
   <div class="grid-container">
        <div class="grid-x grid-padding-x">

        <div class="cell large-6">
          <p>© Copyright WTFPL</p>
        </div>
        <div class="cell large-6">
            <div class="text-right">

            <a href="http://getpelican.com/">Site généré par Pelican</a>
        </div>
        </div>
      </div>
    </div>
  </footer>
</section> 
  <!-- End Footer -->

    <script src="../../../../theme/js/jquery.js"></script>
<!--    <script src="../../../../theme/js/foundation.min.js"></script>-->
     <script>
        $(document).foundation();
    </script>
	
	<script src="../../../../theme/js/lightbox-2.6.min.js"></script>
  


    <script src="../../../../theme/js/app.js"></script>



  </body>
</html>